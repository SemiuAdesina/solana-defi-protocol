name: ci

on:
  push:
    branches:
      - main
  pull_request:

env:
  CARGO_TERM_COLOR: always

jobs:
  audit-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.82.0
          components: clippy
      - name: Install pnpm
        run: corepack enable
      - name: Backend install
        working-directory: backend
        run: pnpm install
      - name: Frontend install
        working-directory: frontend
        run: pnpm install
      - name: Cargo audit
        working-directory: blockchain
        run: |
          cargo install cargo-audit --locked || true
          cargo audit || echo "Warning: cargo audit found issues (non-blocking)"
      - name: npm audit backend
        working-directory: backend
        run: |
          pnpm audit --audit-level=high || echo "Warning: npm audit found issues (non-blocking)"
      - name: npm audit frontend
        working-directory: frontend
        run: |
          pnpm audit --audit-level=high || echo "Warning: npm audit found issues (non-blocking)"

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.82.0
          components: clippy, rustfmt
      - name: Install pnpm
        run: corepack enable
      - name: Backend lint
        working-directory: backend
        run: |
          pnpm install
          pnpm lint
      - name: Frontend lint
        working-directory: frontend
        run: |
          pnpm install
          pnpm lint
      - name: Blockchain clippy
        working-directory: blockchain
        run: |
          cargo clippy --all-targets --all-features -- -D warnings || {
            echo "Clippy found warnings or errors"
            exit 1
          }
      - name: Blockchain fmt
        working-directory: blockchain
        run: cargo fmt -- --check
      - name: Solana program static analysis
        working-directory: blockchain
        run: |
          cargo install cargo-audit --locked
          cargo clippy --all-targets --all-features -- -D warnings -W clippy::arithmetic_side_effects -W clippy::unwrap_used

  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.82.0
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          export PATH="$HOME/.avm/bin:$PATH"
          echo "$HOME/.avm/bin" >> $GITHUB_PATH
          # Install Anchor 0.30.1
          echo "Installing Anchor 0.30.1..."
          # Clean up ALL possible anchor binaries and conflicts (including bad symlinks)
          rm -f "$HOME/.avm/bin/anchor" "$HOME/.avm/bin/anchor-cli" 2>/dev/null || true
          # Remove bad symlinks (that point to avm itself)
          if [ -L "$HOME/.avm/bin/anchor" ] && [ "$(readlink "$HOME/.avm/bin/anchor")" = "/home/runner/.avm/bin/avm" ]; then
            echo "Removing bad symlink: anchor -> avm"
            rm -f "$HOME/.avm/bin/anchor"
          fi
          rm -rf "$HOME/.avm/versions/0.30.1"
          # Also remove from cargo bin if it exists there (might cause conflicts)
          rm -f "$HOME/.cargo/bin/anchor" "$HOME/.cargo/bin/anchor-cli" 2>/dev/null || true
          # Find and remove any existing anchor binaries that might conflict
          find "$HOME/.cargo/bin" -name "anchor*" -type f -delete 2>/dev/null || true
          # Install Anchor 0.30.1 - try multiple methods
          echo "Attempting avm install 0.30.1..."
          set +e
          timeout 180 yes | avm install 0.30.1 2>&1 | tee /tmp/avm-install.log
          AVM_EXIT=${PIPESTATUS[0]}
          set -e
          
          # Check if avm install actually succeeded
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "✓ avm install succeeded - binary found"
          else
            echo "✗ avm install failed (exit code: $AVM_EXIT) - binary not found"
            echo "Last 30 lines of avm install output:"
            tail -30 /tmp/avm-install.log || echo "No log file found"
            
            echo "Trying cargo install as fallback..."
            export PATH="$HOME/.cargo/bin:$PATH"
            
            # Try cargo install without --locked first (allows dependency resolution for Rust 1.82.0)
            echo "Attempting cargo install without --locked flag..."
            set +e
            cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --force >/tmp/cargo-install.log 2>&1
            CARGO_EXIT=$?
            set -e
            
            if [ "$CARGO_EXIT" -eq 0 ]; then
              echo "✓ Cargo install succeeded"
            else
              echo "✗ Cargo install failed (exit code: $CARGO_EXIT)"
              echo "Last 50 lines of cargo install output:"
              tail -50 /tmp/cargo-install.log || echo "No log file found"
            fi
            
            # Check if cargo install actually created the binary
            if command -v anchor-cli >/dev/null 2>&1; then
              mkdir -p "$HOME/.avm/bin"
              rm -f "$HOME/.avm/bin/anchor"
              ln -sfn "$(which anchor-cli)" "$HOME/.avm/bin/anchor"
              chmod +x "$HOME/.avm/bin/anchor"
              echo "✓ Using cargo-installed anchor-cli (from PATH)"
            elif [ -f "$HOME/.cargo/bin/anchor-cli" ]; then
              mkdir -p "$HOME/.avm/bin"
              rm -f "$HOME/.avm/bin/anchor"
              ln -sfn "$HOME/.cargo/bin/anchor-cli" "$HOME/.avm/bin/anchor"
              chmod +x "$HOME/.avm/bin/anchor"
              echo "✓ Using cargo-installed anchor-cli (from explicit path)"
            else
              echo "✗ Cargo install also failed - anchor-cli not found in PATH or cargo/bin"
            fi
          fi
          sleep 3
          # Create symlink directly if version exists
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            mkdir -p "$HOME/.avm/bin"
            rm -f "$HOME/.avm/bin/anchor" "$HOME/.avm/bin/anchor-cli"
            ln -sfn "$HOME/.avm/versions/0.30.1/anchor" "$HOME/.avm/bin/anchor"
            chmod +x "$HOME/.avm/bin/anchor"
            echo "Created direct symlink to Anchor 0.30.1"
          elif command -v anchor-cli >/dev/null 2>&1 && [ ! -f "$HOME/.avm/bin/anchor" ]; then
            # Fallback: use cargo-installed version if available
            mkdir -p "$HOME/.avm/bin"
            ln -sfn "$(which anchor-cli)" "$HOME/.avm/bin/anchor"
            chmod +x "$HOME/.avm/bin/anchor"
            echo "Using cargo-installed anchor-cli as fallback"
          fi
          # Verify and set version in avm config
          export PATH="$HOME/.cargo/bin:$HOME/.avm/bin:$PATH"
          if ! command -v anchor >/dev/null 2>&1 && ! command -v anchor-cli >/dev/null 2>&1 && [ ! -f "$HOME/.cargo/bin/anchor-cli" ]; then
            echo "WARNING: Anchor CLI not found after installation"
            echo "Debug info:"
            avm list 2>&1 || true
            ls -la "$HOME/.avm/bin/" 2>&1 || true
            ls -la "$HOME/.avm/versions/0.30.1/" 2>&1 || true
            ls -la "$HOME/.cargo/bin/anchor*" 2>&1 || true
            echo "Note: Will try to find Anchor CLI during test step"
          fi
          # Set anchor version in avm config (required for anchor commands)
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "Setting Anchor version to 0.30.1..."
            yes | avm use 0.30.1 2>&1 || echo "Note: avm use may have issues, but binary exists"
          fi
          # Verify anchor works - try direct binary call if avm wrapper fails
          export PATH="$HOME/.avm/bin:$PATH"
          if anchor --version 2>&1; then
            echo "Anchor CLI ready and verified"
          elif [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "Using Anchor binary directly (avm wrapper not working)"
            "$HOME/.avm/versions/0.30.1/anchor" --version 2>&1 || echo "Warning: Could not get anchor version"
          else
            echo "Warning: anchor --version failed, but continuing..."
          fi
      - name: Install pnpm
        run: corepack enable
      - name: Backend test
        working-directory: backend
        run: |
          pnpm install
          pnpm test
      - name: Frontend test
        working-directory: frontend
        run: |
          pnpm install
          pnpm test
      - name: Anchor test
        working-directory: blockchain
        run: |
          export PATH="$HOME/.avm/bin:$PATH"
          
          # Find and use Anchor CLI - prioritize direct binary path
          ANCHOR_CMD=""
          
          # Priority 1: Direct binary path (doesn't need avm config, most reliable)
          DIRECT_BINARY="$HOME/.avm/versions/0.30.1/anchor"
          if [ -f "$DIRECT_BINARY" ]; then
            echo "Found direct Anchor binary at: $DIRECT_BINARY"
            if "$DIRECT_BINARY" --version >/dev/null 2>&1; then
              ANCHOR_CMD="$DIRECT_BINARY"
              echo "✓ Using direct binary (no avm config needed)"
            else
              echo "Direct binary exists but failed version check"
            fi
          fi
          
          # Priority 2: Try avm wrapper if direct binary didn't work
          if [ -z "$ANCHOR_CMD" ] && command -v avm >/dev/null 2>&1; then
            echo "Attempting to configure avm wrapper..."
            if yes | avm use 0.30.1 >/dev/null 2>&1; then
              if command -v anchor >/dev/null 2>&1; then
                if anchor --version >/dev/null 2>&1; then
                  ANCHOR_CMD="anchor"
                  echo "✓ Using anchor via avm wrapper"
                fi
              fi
            fi
          fi
          
          # Priority 3: Try anchor-cli from cargo (if installed during setup)
          # Check both PATH and explicit cargo bin location
          export PATH="$HOME/.cargo/bin:$PATH"
          if [ -z "$ANCHOR_CMD" ]; then
            if command -v anchor-cli >/dev/null 2>&1; then
              ANCHOR_CMD="anchor-cli"
              echo "✓ Using anchor-cli from PATH"
            elif [ -f "$HOME/.cargo/bin/anchor-cli" ]; then
              ANCHOR_CMD="$HOME/.cargo/bin/anchor-cli"
              echo "✓ Using anchor-cli from cargo bin"
            fi
          fi
          
          # Priority 4: Fallback to direct binary even if test failed earlier
          if [ -z "$ANCHOR_CMD" ] && [ -f "$DIRECT_BINARY" ]; then
            ANCHOR_CMD="$DIRECT_BINARY"
            echo "✓ Fallback: Using direct binary path"
          fi
          
          # Verify Anchor CLI is available
          if [ -z "$ANCHOR_CMD" ]; then
            echo "ERROR: Cannot find working Anchor CLI"
            echo "Debug information:"
            echo "  Checking direct binary:"
            ls -la "$DIRECT_BINARY" 2>&1 || echo "    Not found at $DIRECT_BINARY"
            echo "  Checking versions directory:"
            ls -la "$HOME/.avm/versions/0.30.1/" 2>&1 | head -5 || echo "    Directory does not exist"
            echo "  Checking avm bin:"
            ls -la "$HOME/.avm/bin/" 2>&1 | head -5 || echo "    Directory does not exist"
            echo "  Checking for anchor-cli:"
            command -v anchor-cli 2>&1 || echo "    anchor-cli not found"
            echo "  Checking avm versions:"
            avm list 2>&1 | head -10 || echo "    avm command not available"
            exit 1
          fi
          
          # Test Anchor CLI
          echo "Testing Anchor CLI (command: $ANCHOR_CMD):"
          if $ANCHOR_CMD --version 2>&1; then
            echo "✓ Anchor CLI is working"
          else
            echo "ERROR: Anchor CLI failed version check"
            exit 1
          fi
          
          echo "Running Anchor tests..."
          $ANCHOR_CMD test -- --nocapture
      - name: Generate coverage report
        working-directory: blockchain
        run: |
          cargo install cargo-llvm-cov --locked
          cargo llvm-cov --locked --all-features --workspace --lcov --output-path lcov.info
      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./blockchain/lcov.info
          flags: blockchain
          name: blockchain-coverage
          fail_ci_if_error: false
      - name: Check coverage threshold
        working-directory: blockchain
        run: |
          # Extract coverage percentage from cargo llvm-cov output
          coverage_output=$(cargo llvm-cov --locked --all-features --workspace --summary-only 2>&1 || echo "")
          coverage=$(echo "$coverage_output" | grep -E "Total.*[0-9]+\.[0-9]+%" | sed -E 's/.*Total.*([0-9]+\.[0-9]+)%.*/\1/' | head -1 || echo "0")
          echo "Coverage: ${coverage}%"
          # Convert to integer for comparison (multiply by 100)
          coverage_int=$(echo "$coverage" | awk '{printf "%.0f", $1 * 1}')
          if [ -z "$coverage_int" ] || [ "$coverage_int" -lt 80 ]; then
            echo "ERROR: Coverage ${coverage}% is below 80% threshold"
            exit 1
          fi
          echo "Coverage check passed: ${coverage}%"

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: 1.82.0
      - name: Install Solana CLI
        run: |
          sh -c "$(curl -sSfL https://release.solana.com/stable/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH
      - name: Install Anchor CLI
        run: |
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          export PATH="$HOME/.avm/bin:$PATH"
          echo "$HOME/.avm/bin" >> $GITHUB_PATH
          # Install Anchor 0.30.1
          echo "Installing Anchor 0.30.1..."
          # Clean up ALL possible anchor binaries and conflicts (including bad symlinks)
          rm -f "$HOME/.avm/bin/anchor" "$HOME/.avm/bin/anchor-cli" 2>/dev/null || true
          # Remove bad symlinks (that point to avm itself)
          if [ -L "$HOME/.avm/bin/anchor" ] && [ "$(readlink "$HOME/.avm/bin/anchor")" = "/home/runner/.avm/bin/avm" ]; then
            echo "Removing bad symlink: anchor -> avm"
            rm -f "$HOME/.avm/bin/anchor"
          fi
          rm -rf "$HOME/.avm/versions/0.30.1"
          # Also remove from cargo bin if it exists there (might cause conflicts)
          rm -f "$HOME/.cargo/bin/anchor" "$HOME/.cargo/bin/anchor-cli" 2>/dev/null || true
          # Find and remove any existing anchor binaries that might conflict
          find "$HOME/.cargo/bin" -name "anchor*" -type f -delete 2>/dev/null || true
          # Install Anchor 0.30.1 - try multiple methods
          echo "Attempting avm install 0.30.1..."
          set +e
          timeout 180 yes | avm install 0.30.1 2>&1 | tee /tmp/avm-install.log
          AVM_EXIT=${PIPESTATUS[0]}
          set -e
          
          # Check if avm install actually succeeded
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "✓ avm install succeeded - binary found"
          else
            echo "✗ avm install failed (exit code: $AVM_EXIT) - binary not found"
            echo "Last 30 lines of avm install output:"
            tail -30 /tmp/avm-install.log || echo "No log file found"
            
            echo "Trying cargo install as fallback..."
            export PATH="$HOME/.cargo/bin:$PATH"
            
            # Try cargo install without --locked first (allows dependency resolution for Rust 1.82.0)
            echo "Attempting cargo install without --locked flag..."
            set +e
            cargo install --git https://github.com/coral-xyz/anchor --tag v0.30.1 anchor-cli --force >/tmp/cargo-install.log 2>&1
            CARGO_EXIT=$?
            set -e
            
            if [ "$CARGO_EXIT" -eq 0 ]; then
              echo "✓ Cargo install succeeded"
            else
              echo "✗ Cargo install failed (exit code: $CARGO_EXIT)"
              echo "Last 50 lines of cargo install output:"
              tail -50 /tmp/cargo-install.log || echo "No log file found"
            fi
            
            # Check if cargo install actually created the binary
            if command -v anchor-cli >/dev/null 2>&1; then
              mkdir -p "$HOME/.avm/bin"
              rm -f "$HOME/.avm/bin/anchor"
              ln -sfn "$(which anchor-cli)" "$HOME/.avm/bin/anchor"
              chmod +x "$HOME/.avm/bin/anchor"
              echo "✓ Using cargo-installed anchor-cli (from PATH)"
            elif [ -f "$HOME/.cargo/bin/anchor-cli" ]; then
              mkdir -p "$HOME/.avm/bin"
              rm -f "$HOME/.avm/bin/anchor"
              ln -sfn "$HOME/.cargo/bin/anchor-cli" "$HOME/.avm/bin/anchor"
              chmod +x "$HOME/.avm/bin/anchor"
              echo "✓ Using cargo-installed anchor-cli (from explicit path)"
            else
              echo "✗ Cargo install also failed - anchor-cli not found in PATH or cargo/bin"
            fi
          fi
          sleep 3
          # Create symlink directly if version exists
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            mkdir -p "$HOME/.avm/bin"
            rm -f "$HOME/.avm/bin/anchor" "$HOME/.avm/bin/anchor-cli"
            ln -sfn "$HOME/.avm/versions/0.30.1/anchor" "$HOME/.avm/bin/anchor"
            chmod +x "$HOME/.avm/bin/anchor"
            echo "Created direct symlink to Anchor 0.30.1"
          elif command -v anchor-cli >/dev/null 2>&1 && [ ! -f "$HOME/.avm/bin/anchor" ]; then
            # Fallback: use cargo-installed version if available
            mkdir -p "$HOME/.avm/bin"
            ln -sfn "$(which anchor-cli)" "$HOME/.avm/bin/anchor"
            chmod +x "$HOME/.avm/bin/anchor"
            echo "Using cargo-installed anchor-cli as fallback"
          fi
          # Verify and set version in avm config
          export PATH="$HOME/.cargo/bin:$HOME/.avm/bin:$PATH"
          if ! command -v anchor >/dev/null 2>&1 && ! command -v anchor-cli >/dev/null 2>&1 && [ ! -f "$HOME/.cargo/bin/anchor-cli" ]; then
            echo "WARNING: Anchor CLI not found after installation"
            echo "Debug info:"
            avm list 2>&1 || true
            ls -la "$HOME/.avm/bin/" 2>&1 || true
            ls -la "$HOME/.avm/versions/0.30.1/" 2>&1 || true
            ls -la "$HOME/.cargo/bin/anchor*" 2>&1 || true
            echo "Note: Will try to find Anchor CLI during test step"
          fi
          # Set anchor version in avm config (required for anchor commands)
          if [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "Setting Anchor version to 0.30.1..."
            yes | avm use 0.30.1 2>&1 || echo "Note: avm use may have issues, but binary exists"
          fi
          # Verify anchor works - try direct binary call if avm wrapper fails
          export PATH="$HOME/.avm/bin:$PATH"
          if anchor --version 2>&1; then
            echo "Anchor CLI ready and verified"
          elif [ -f "$HOME/.avm/versions/0.30.1/anchor" ]; then
            echo "Using Anchor binary directly (avm wrapper not working)"
            "$HOME/.avm/versions/0.30.1/anchor" --version 2>&1 || echo "Warning: Could not get anchor version"
          else
            echo "Warning: anchor --version failed, but continuing..."
          fi
      - name: Install pnpm
        run: corepack enable
      - name: Backend build
        working-directory: backend
        run: |
          pnpm install
          pnpm build
      - name: Frontend build
        working-directory: frontend
        run: |
          pnpm install
          pnpm build
      - name: Blockchain release build
        working-directory: blockchain
        run: cargo build --release
      - name: Notify CI status webhook
        if: always()
        env:
          API_KEY: ${{ secrets.CI_WEBHOOK_API_KEY }}
          BACKEND_URL: ${{ secrets.BACKEND_URL }}
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            status="success"
          else
            status="failed"
          fi
          BACKEND_URL_FINAL="${BACKEND_URL:-http://localhost:4000}"
          
          echo "=== CI Webhook Debug Info ==="
          echo "Job Status: ${{ job.status }}"
          echo "CI Status: ${status}"
          echo "Backend URL: ${BACKEND_URL_FINAL}"
          echo "API Key Set: $([ -n "${API_KEY}" ] && echo "Yes" || echo "No")"
          echo "Commit: ${{ github.sha }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Actor: ${{ github.actor }}"
          echo "=============================="
          
          if [ -z "${API_KEY}" ]; then
            echo "❌ ERROR: CI_WEBHOOK_API_KEY secret is not set!"
            echo "Go to: Settings → Secrets and variables → Actions"
            exit 0
          fi
          
          if [ "${BACKEND_URL_FINAL}" == "http://localhost:4000" ]; then
            echo "⚠️  WARNING: BACKEND_URL is not set or is localhost!"
            echo "GitHub Actions cannot reach localhost. Set BACKEND_URL to your deployed backend URL."
            echo "Example: https://your-backend.railway.app or https://your-backend.render.com"
            exit 0
          fi
          
          echo "Sending webhook to ${BACKEND_URL_FINAL}/ci/status/webhook..."
          response=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST "${BACKEND_URL_FINAL}/ci/status/webhook" \
            -H "Content-Type: application/json" \
            -H "x-api-key: ${API_KEY}" \
            -d "{
              \"pipeline\": \"lint + tests + coverage\",
              \"status\": \"${status}\",
              \"commit\": \"${{ github.sha }}\",
              \"runId\": \"run-${{ github.run_id }}\",
              \"triggeredBy\": \"${{ github.actor }}\"
            }")
          
          http_code=$(echo "$response" | grep "HTTP_CODE" | cut -d: -f2)
          body=$(echo "$response" | sed '/HTTP_CODE/d')
          
          if [ "${http_code}" == "202" ]; then
            echo "✅ Webhook sent successfully! Response: ${body}"
          else
            echo "❌ Webhook failed! HTTP ${http_code}"
            echo "Response: ${body}"
          fi

